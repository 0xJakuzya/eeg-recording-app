# EEG Recording App

Мобильное Flutter-приложение создано для работы с полисомнографией — исследованиями сна. Позволяет регистрировать ЭЭГ-сигналы с BLE-устройств, управлять записями и интегрировать данные с сервисом полисомнографии для автоматического анализа стадий сна и построения гипнограмм.

## О приложении

Приложение предназначено для полисомнографических исследований — комплексной диагностики сна, включающей регистрацию электроэнцефалограммы (ЭЭГ) во время ночного сна. Поддерживается:

- Подключение к ЭЭГ-датчикам по Bluetooth Low Energy
- Запись и визуализация данных в реальном времени
- Сохранение записей в форматах TXT/CSV
- Загрузка данных на сервер полисомнографии
- Получение результатов анализа стадий сна (гипнограммы) и интервалов фаз (N1, N2, N3, REM, Wake)

## Основные возможности

### Подключение к BLE-устройствам
- Сканирование и подключение к EEG BLE-устройствам
- Отслеживание состояния подключения в реальном времени

### Запись ЭЭГ
- Потоковая запись в TXT/CSV с буферизацией и ротацией по времени
- Поддержка формата int24Be (до 8 каналов)
- **Notch-фильтр 50 Гц** — подавление сетевой частоты для полисомнографии
- Foreground service — непрерывная запись при свёрнутом экране

### Визуализация сигналов
- Онлайн-отображение до 8 каналов в реальном времени
- Скользящее окно (3/5/10 с) и регулировка масштаба амплитуды

### Работа с файлами
- Просмотр списка записей и директорий
- Удаление файлов и папок с синхронизацией счётчика сессий
- Шаринг и просмотр содержимого TXT

### Интеграция с полисомнографией
- **FilesPage** — загрузка выбранных файлов (POST `/users/save_user_file`)
- **ProcessedFilesPage** — загрузка сессий и автообработка предикта (POST `/users/save_predict_json`)
- **SessionDetailsPage** — гипнограмма (GET `/users/sleep_graph?index=N`), интервалы стадий сна

### Настройки
- Папка для записей, формат файла (TXT/CSV)
- Количество каналов (1–8), интервал ротации
- Частота дискретизации (100/250/500 Гц)
- Формат данных (int24Be)
- Адрес сервера полисомнографии
- Кастомные команды на устройство

## Требования к данным для полисомнографии

Для корректного анализа моделями на сервере необходимо соблюдать параметры:

| Параметр | Значение |
|----------|----------|
| **Частота дискретизации** | 100 Гц |
| **Фильтр подавления сетевой частоты** | 50 Гц (Notch) |
| **Количество каналов (TXT)** | 1 канал |

Перед записью установите частоту **100 Гц** в настройках (Bluetooth → Частота дискретизации). Фильтр 50 Гц применяется при записи автоматически.

## Структура экранов

![Схема страниц приложения](assets/PageDiagram.png)

*Схема навигации: подключение к устройствам → запись → управление файлами → обработанные сессии.*

## Архитектура данных

### Поток записи ЭЭГ

```
BLE Device (notify)
    ↓
BleController.selectedDataCharacteristic.lastValueStream
    ↓
RecordingController.onDataReceived(bytes)
    ↓
EegParserService.parseAllBytes() → List<EegSample> (int24Be)
    ↓
Notch50HzFilter.process() — подавление 50 Гц
    ↓
CsvStreamWriter.writeSample() → buffer → flush при 100 строках
    ↓
Файл: dd.MM.yyyy/session_N/session_N_dd.MM.yyyy_HH-mm.txt
```

### Интеграция с полисомнографией

```
TXT/EDF (1 канал, 100 Гц, фильтр 50 Гц)
    ↓
POST /users/save_user_file (patient_id, patient_name, sampling_frequency для .txt)
    ↓
POST /users/save_predict_json (patient_id, file_index, channel для .edf)
    ↓
PredictResult(prediction, jsonIndex)
    ↓
GET /users/sleep_graph?index=N → PNG гипнограмма
    ↓
SessionDetailsPage: изображение + интервалы стадий
```

## Установка и запуск

### Требования
- Flutter SDK 3.10+
- Android 5.0+ / iOS 11+ (для BLE и записи)

### Шаги

1. Клонируйте репозиторий и перейдите в каталог:
   ```bash
   cd eeg-recording-app
   ```

2. Установите зависимости:
   ```bash
   flutter pub get
   ```

3. Запустите приложение:
   ```bash
   flutter run
   ```

### Настройка полисомнографии

- **Настройки → Полисомнография → Адрес сервера**
- Укажите URL API, например: `http://192.168.0.174:8000`
- Дефолтный адрес: `lib/core/constants/polysomnography_constants.dart`
- При смене Wi-Fi IP компьютера обновите адрес (`ipconfig` на Windows)


## Структура проекта

```
lib/
├── main.dart
├── core/
│   ├── constants/
│   │   ├── ble_constants.dart
│   │   ├── recording_constants.dart
│   │   └── polysomnography_constants.dart
│   ├── theme/
│   │   └── app_theme.dart
│   ├── utils/
│   │   ├── format_extensions.dart
│   │   └── signal_filters.dart           # Notch50HzFilter
│   └── common/
│       ├── eeg_sample.dart
│       └── recording_models.dart
│
└── features/
    ├── ble/                             # BLE-подключение
    ├── recording/                       # Запись и визуализация ЭЭГ
    ├── files/                           # Управление файлами
    ├── polysomnography/                 # Интеграция с сервисом полисомнографии
    ├── settings/                        # Настройки приложения
    └── navigation/                      # Навигация
```

## Зависимости

| Пакет | Назначение |
|-------|------------|
| flutter_blue_plus | BLE-подключение |
| fl_chart | Графики сигналов |
| flutter_foreground_task | Запись в фоне |
| dio, http | Запросы к API полисомнографии |
| get | State management и навигация |

